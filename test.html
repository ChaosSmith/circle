<!DOCTYPE html>
<html>

<head>
	<title>Tag</title>
	<meta charset="utf-8"/>
</head>

<body>
	<script>

function request(action, method, body){
	const r={method};
	if(body) r.body=JSON.stringify(body);
	let url='http://10.88.111.70:8000/'+action;
	return fetch(url, r);
}

var canvas;
var context;

function get_colors(id){
	const base=[
		'rgb(255, 0, 0)',
		'rgb(0, 255, 0)',
		'rgb(0, 0, 255)',
		'rgb(255, 0, 255)',
		'rgb(255, 255, 0)',
		'rgb(0, 255, 255)',
		'rgb(255, 127, 0)',
		'rgb(128, 0, 128)',
	];
	result=[];
	while(id){
		result.push(base[id%8]);
		id=Math.floor(id/8);
	}
	return result;
}

function render(){
	request('agent', 'GET')
		.then((r)=>{ return r.json(); })
		.then((j)=>{
			j=j.agents;
			//background
			context.fillStyle='rgb(255, 255, 255)';
			context.fillRect(0, 0, 512, 512);
			for(let i=0; i<128; ++i)
				for(let j=0; j<128; ++j){
					if((i+j)%2) continue;
					let color='rgb(224, 224, 224)';
					if((Math.floor(i/8)+Math.floor(j/8))%2) color='rgb(196, 196, 196)';
					context.fillStyle=color;
					context.fillRect(i*4, j*4, 4, 4);
				}
			//players
			for(let i=0; i<j.length; ++i){
				const colors=get_colors(j[i].id);
				for(let k=0; k<colors.length; ++k){
					context.fillStyle=colors[k];
					const dx=4/colors.length;
					context.fillRect(
						j[i].x*4+dx*k,
						j[i].y*4,
						dx,
						4
					);
				}
			}
			//again
			setTimeout(render, 500);
		});
}

function main(){
	canvas=document.getElementById('canvas');
	context=canvas.getContext('2d');
	render();
}

window.onload=main;

	</script>
	<canvas id='canvas' width=512 height=512></canvas>
</body>

</html>
